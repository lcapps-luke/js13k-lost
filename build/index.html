<!DOCTYPE html><html lang=en><head><meta charset=utf-8><script src=https://aframe.io/releases/0.6.1/aframe.min.js></script><script>function SfxrParams(){this.setSettings=function(t){for(var e=0;e<24;e++)this[String.fromCharCode(97+e)]=t[e]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;if(i<.18){var a=.18/i;this.b*=a,this.c*=a,this.e*=a}}}function SfxrSynth(){this._params=new SfxrParams;var t,e,i,a,r,o,n,s,l,h,c,d;this.reset=function(){var t=this._params;a=100/(t.f*t.f+.001),r=100/(t.g*t.g+.001),o=1-t.h*t.h*t.h*.01,n=-t.i*t.i*t.i*1e-6,t.a||(c=.5-t.n/2,d=5e-5*-t.o),s=1+t.l*t.l*(t.l>0?-.9:10),l=0,h=1==t.m?0:(1-t.m)*(1-t.m)*2e4+32},this.totalReset=function(){this.reset();var a=this._params;return t=a.b*a.b*1e5,e=a.c*a.c*1e5,i=a.e*a.e*1e5+12,3*((t+e+i)/3|0)},this.synthWave=function(p,u){var y=this._params,f=1!=y.s||y.v,m=y.v*y.v*.1,g=1+3e-4*y.w,v=y.s*y.s*y.s*.1,b=1+1e-4*y.t,w=1!=y.s,k=y.x*y.x,A=y.g,E=y.q||y.r,x=y.r*y.r*y.r*.2,C=y.q*y.q*(y.q<0?-1020:1020),S=y.p?32+((1-y.p)*(1-y.p)*2e4|0):0,z=y.d,j=y.j/2,L=y.k*y.k*.01,M=y.a,R=t,D=1/t,q=1/e,F=1/i,T=5/(1+y.u*y.u*20)*(.01+v);T>.8&&(T=.8),T=1-T;for(var B,N,P,H,V,W,_=!1,O=0,U=0,G=0,I=0,J=0,K=0,Q=0,X=0,Y=0,Z=0,$=new Array(1024),tt=new Array(32),et=$.length;et--;)$[et]=0;for(et=tt.length;et--;)tt[et]=2*Math.random()-1;for(et=0;et<u;et++){if(_)return et;if(S&&++Y>=S&&(Y=0,this.reset()),h&&++l>=h&&(h=0,a*=s),o+=n,(a*=o)>r&&(a=r,A>0&&(_=!0)),N=a,j>0&&(Z+=L,N*=1+Math.sin(Z)*j),(N|=0)<8&&(N=8),M||((c+=d)<0?c=0:c>.5&&(c=.5)),++U>R)switch(U=0,++O){case 1:R=e;break;case 2:R=i}switch(O){case 0:G=U*D;break;case 1:G=1+2*(1-U*q)*z;break;case 2:G=1-U*F;break;case 3:G=0,_=!0}E&&((P=0|(C+=x))<0?P=-P:P>1023&&(P=1023)),f&&g&&((m*=g)<1e-5?m=1e-5:m>.1&&(m=.1)),W=0;for(var it=8;it--;){if(++Q>=N&&(Q%=N,3==M))for(var at=tt.length;at--;)tt[at]=2*Math.random()-1;switch(M){case 0:V=Q/N<c?.5:-.5;break;case 1:V=1-Q/N*2;break;case 2:V=.225*(((V=1.27323954*(H=6.28318531*((H=Q/N)>.5?H-1:H))+.405284735*H*H*(H<0?1:-1))<0?-1:1)*V*V-V)+V;break;case 3:V=tt[Math.abs(32*Q/N|0)]}f&&(B=K,(v*=b)<0?v=0:v>.1&&(v=.1),w?(J+=(V-K)*v,J*=T):(K=V,J=0),I+=(K+=J)-B,V=I*=1-m),E&&($[X%1024]=V,V+=$[(X-P+1024)%1024],X++),W+=V}W*=.125*G*k,p[et]=W>=1?32767:W<=-1?-32768:32767*W|0}return u}}var synth=new SfxrSynth,jsfxr=function(t){synth._params.setSettings(t);var e=synth.totalReset(),i=new Uint8Array(4*((e+1)/2|0)+44),a=2*synth.synthWave(new Uint16Array(i.buffer,44),e),r=new Uint32Array(i.buffer,0,44);r[0]=1179011410,r[1]=a+36,r[2]=1163280727,r[3]=544501094,r[4]=16,r[5]=65537,r[6]=44100,r[7]=88200,r[8]=1048578,r[9]=1635017060,r[10]=a,a+=44;for(var o=0,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s="data:audio/wav;base64,";o<a;o+=3){var l=i[o]<<16|i[o+1]<<8|i[o+2];s+=n[l>>18]+n[l>>12&63]+n[l>>6&63]+n[63&l]}return s};"function"==typeof require?module.exports=jsfxr:this.jsfxr=jsfxr;var LevelDef={template:{navNode:{type:"a-entity",attr:{geometry:"primitive:circle",material:"shader:flat;flatShading:true",lookat:"#player",class:"clickable",navigation:""}},tree:{type:"a-entity",attr:{shadow:""},children:[{type:"a-entity",attr:{geometry:"radius:0.8;height:6;primitive:cylinder",material:"color:#804000;roughness:1",position:"0 3 0"}},{type:"a-entity",attr:{geometry:"radius:2.3;primitive:sphere",position:"0 7.5 0",material:"color:#008000;roughness:1"}}]}},maze:{"left.json":{floor:[{x:0,y:0,width:1024,height:1024}],solid:[{x:0,y:0,width:32,height:992},{x:32,y:0,width:992,height:32},{x:992,y:32,width:32,height:992},{x:0,y:992,width:992,height:32}],width:1024,height:1024}},level:{"hub.json":{player:{x:-9,y:1.6,z:0},objects:[{type:"a-plane",attr:{rotation:"-90 0 0",width:"100",height:"100",color:"#009b00",shadow:""}},{type:"a-plane",attr:{rotation:"90 0 0",width:"100",height:"100",color:"#009b00",shadow:"",position:"0 5 0"}}]},"left.json":{player:{x:0,y:1.6,z:0},objects:[{type:"a-entity",attr:{maze:"maze: left.json; size: 100 100 100",position:"0 0 0"}}]},"start.json":{player:{x:-9,y:1.6,z:0},objects:[{type:"a-sky",attr:{color:"#00AAEE"}},{type:"a-entity",attr:{light:"shadowCameraRight:44; shadowCameraLeft:-30; shadowCameraTop:26; shadowCameraBottom:-31; shadowCameraFar:150; shadowCameraNear:0; castShadow:true; shadowMapHeight: 512; shadowMapWidth: 512;",position:"-30 40 -15"}},{type:"a-entity",attr:{light:"intensity:0.15;type:ambient"}},{type:"a-plane",attr:{rotation:"-90 0 0",width:"100",height:"100",color:"#009b00",shadow:""}},{type:"a-box",attr:{position:"5 2.5 -2.5",color:"#4CC3D9",material:"",geometry:"height:5;width:10",shadow:"",class:"solid"}},{type:"a-box",attr:{position:"5 5.5 0",rotation:"90 0 0",color:"#4CC3D9",material:"",geometry:"height:5;width:10",shadow:"",class:"solid"}},{type:"a-box",attr:{position:"5 2.5 2.5",color:"#4CC3D9",material:"",geometry:"height:5;width:10",shadow:"",class:"solid"}},{type:"a-box",attr:{position:"9.392 2.047 -1.954",geometry:"depth:0.3;width:0.2;height:0.2",switch:"target:#door; event:open",class:"clickable",clickableupdator:"1500",lostsound:"snd:click; on: click"}},{type:"a-entity",attr:{position:"10.246 2.524 0",id:"door",geometry:"width:0.5;height:5;depth:4",class:"solid"},children:[{type:"a-animation",attr:{begin:"open",attribute:"position",from:"10.246 2.524 0",to:"10.246 2.524 4",duration:"1500",easing:"ease-in",fill:"forwards"}}]},{type:"a-entity",attr:{position:"-15 0 -25",forest:"30 20"}},{type:"a-entity",attr:{position:"-15 0 3",forest:"30 20"}},{type:"a-entity",attr:{position:"-35 0 -27",forest:"20 50"}},{type:"a-entity",attr:{position:"-38 4 -0",rotation:"0 90 0",geometry:"width:60;height:8;primitive:plane",material:"color:#391d00;shader:flat"}},{type:"a-entity",attr:{position:"20 4 -0",rotation:"0 270 0",geometry:"width:60;height:8;primitive:plane",material:"color:#391d00;shader:flat"}},{type:"a-entity",attr:{position:"-9 4 -28",rotation:"0 0 0",geometry:"width:60;height:8;primitive:plane",material:"color:#391d00;shader:flat"}},{type:"a-entity",attr:{position:"-9 4 28",rotation:"0 180 0",geometry:"width:60;height:8;primitive:plane",material:"color:#391d00;shader:flat"}},{template:"navNode",attr:{position:"-9 2 0",visible:"false"}},{template:"navNode",attr:{position:"0 2 0"}},{template:"navNode",attr:{position:"6.5 2 0"}},{template:"navNode",attr:{position:"13 2 0"}},{type:"a-entity",attr:{geometry:"primitive:circle",material:"shader:flat;flatShading:true",lookat:"#player",class:"clickable",levelchange:"level:hub.json; position:0 1.6 0",position:"13 2 3"}}]}}};AFRAME.registerComponent("clickableupdator",{schema:{type:"number",default:0},init:function(){this.timer=this.data,this.running=!1;var t=this;this.el.addEventListener("click",function(){t.onClick()}),console.log("updator for "+this.timer)},onClick:function(){this.timer=this.data,this.running=!0,console.log("updator triggered "+this.timer)},tick:function(t,e){if(this.running&&(this.timer-=e,this.timer<=0)){this.running=!1;var i=this.el.sceneEl.querySelector("#player");i.emit("move",i.getAttribute("position")),console.log("update!!!")}}}),AFRAME.registerComponent("forest",{schema:{type:"vec2"},init:function(){this.el;for(var t=this.data.x,e=this.data.y,i=0;i<t;i+=3.6)for(var a=0;a<e;a+=3.6){var r=i+.8+2*Math.random(),o=a+.8+2*Math.random(),n=-3*Math.random(),s=SceneBuilder.buildElement(LevelDef.template.tree);s.setAttribute("position",r+" "+n+" "+o),this.el.appendChild(s)}}}),AFRAME.registerComponent("levelchange",{schema:{level:{type:"string"},delay:{type:"number",default:0},position:{type:"vec3"}},init:function(){var t=this;this.el&&this.el.addEventListener("click",function(){t.transition()}),this.timer=this.data.delay,this.lit=!1,this.triggered=!1},tick:function(t,e){this.lit&&(this.timer-=e,this.timer<=0&&(this.el.sceneEl.emit("changeLevel",{level:this.data.level,position:this.data.position},!1),this.lit=!1))},transition:function(){this.triggered||(this.lit=!0,this.triggered=!0)}}),AFRAME.registerComponent("lookat",{schema:{type:"selector",default:"[camera]"},init:function(){this.target=null},update:function(){if(this.data){if(!this.data.hasLoaded){var t=this;return t.data.addEventListener("loaded",function(){t.target=t.data.object3D})}this.target=this.data.object3D}},tick:function(){if(this.target){var t=this.el.object3D.parent.worldToLocal(this.target.getWorldPosition()),e=null;this.el.getObject3D("camera")?e.subVectors(this.el.object3D.position,t).add(this.el.object3D.position):e=t,this.el.object3D.lookAt(e)}}}),AFRAME.registerComponent("lostsound",{schema:{snd:{type:"string"},on:{type:"string"}},init:function(){this.el.setAttribute("sound","src: url("+SoundLibrary[this.data.snd]+"); on: "+this.data.on)}}),AFRAME.registerComponent("lost",{init:function(){this.clickableList=[];var t=this;this.el.addEventListener("changeLevel",function(e){t.loadScene(e.detail.level,e.detail.position)}),this.player=this.el.sceneEl.querySelector("#player"),this.player.addEventListener("move",function(e){t.onPlayerMove(e.detail)}),this.loadScene("start.json")},tick:function(t,e){},loadScene:function(t,e){for(var i=this.el,a=i.querySelectorAll("a-scene>.vr:not(.global)"),r=0;r<a.length;r++)i.removeChild(a[r]);var o=LevelDef.level[t];SceneBuilder.buildChildren(i,o.objects),this.clickableList=i.querySelectorAll(".clickable"),console.log(e);var n=e||o.player;this.player.setAttribute("position",n),this.onPlayerMove(n),this.el.emit("loaded")},onPlayerMove:function(t){var e=this.el,i=new THREE.Raycaster;i.near=0;for(var a=new THREE.Vector3(t.x,t.y,t.z),r=e.querySelectorAll(".solid"),o=[],n=0;n<r.length;n++)o.push(r[n].object3D);for(n=0;n<this.clickableList.length;n++){var s=this.clickableList[n],l=!1,h=s.getAttribute("position");if(h){var c=new THREE.Vector3(h.x,h.y,h.z),d=a.distanceTo(c);if(d<=10){var p=new THREE.Vector3;p.subVectors(c,a).normalize(),i.far=d,i.set(a,p),0==i.intersectObjects(o,!0).length&&(l=!0)}var u=s.classList.contains("clickable");u&&!l?s.classList.remove("clickable"):!u&&l&&s.classList.add("clickable")}}e.querySelector("#player>.cursor").components.raycaster.refreshObjects()}}),AFRAME.registerComponent("maze",{schema:{maze:{type:"string"},size:{type:"vec3"}},init:function(){var t=LevelDef.maze[this.data.maze];this.build(t)},build:function(t){console.log(t);for(var e in t.floor)this.buildFloor(t.floor[e],t.width,t.height);for(var e in t.solid)this.buildSolid(t.solid[e],t.width,t.height)},buildFloor:function(t,e,i){var a=t.width/e*this.data.size.x,r=t.height/i*this.data.size.y,o={type:"a-plane",attr:{rotation:"-90 0 0",position:t.x/e*this.data.size.x+a/2+" 0 "+(t.y/i*this.data.size.y+r/2),width:a,height:r,color:"#009b00",shadow:""}};this.el.appendChild(SceneBuilder.buildElement(o))},buildSolid:function(t,e,i){var a=t.width/e*this.data.size.x,r=t.height/i*this.data.size.y,o=t.x/e*this.data.size.x+a/2,n=t.y/i*this.data.size.y+r/2,s={type:"a-box",attr:{position:o+" "+this.data.size.z/2+" "+n,width:a,height:this.data.size.z,depth:r,color:"#009b00",shadow:""}},l=SceneBuilder.buildElement(s);this.el.appendChild(l),console.log(l)}}),AFRAME.registerComponent("navigation",{init:function(){var t=this;this.el&&this.el.addEventListener("click",function(){t.click()})},click:function(){var t=this.el.sceneEl.querySelector("#player"),e=this.el.getAttribute("position"),i=t.getAttribute("position"),a=e.x+" "+i.y+" "+e.z,r=document.createElement("a-animation");r.setAttribute("attribute","position"),r.setAttribute("to",a),r.setAttribute("dur","500"),r.setAttribute("repeat","0"),t.appendChild(r),this.el.setAttribute("visible",!1);for(var o=this.el.sceneEl.querySelectorAll("[navigation]"),n=0;n<o.length;n++){var s=o[n];s!==this.el&&s.setAttribute("visible",!0)}t.emit("move",e)}});var SceneBuilder=function(){function t(t,e){var i={};if("attr"in t)for(var a in t.attr)i[a]=t.attr[a];if("attr"in e)for(var a in e.attr)i[a]=e.attr[a];return i}function e(t,e,i){return t in e?e[t]:i[t]}function i(i){var r={};"template"in i&&(r=LevelDef.template[i.template]);var o=document.createElement(e("type",i,r)),n=t(r,i);for(var s in n)o.setAttribute(s,n[s]);return"children"in r&&a(o,r.children),"children"in i&&a(o,i.children),o.classList.add("vr"),o}function a(t,e){for(var a=0;a<e.length;a++){var r=i(e[a]);t.appendChild(r)}}return{buildElement:i,buildChildren:a}}(),SoundLibrary=function(){var t={click:[0,.16,.184,.944,.144,.272,.16,-.008,-.472,.16,.4479,-.2319,.472,.368,.008,,.04,.328,1,.072,.944,,.008,.5]},e={};for(var i in t)e[i]=jsfxr(t[i]);return e}();AFRAME.registerComponent("switch",{schema:{target:{type:"selector"},event:{type:"string"}},init:function(){var t=this;this.el&&this.el.addEventListener("click",function(){t.onClick()})},onClick:function(){console.log("triggering "+this.data.event+" on target:"),console.log(this.data.target),this.data.target.emit(this.data.event)}});</script></head><body><a-scene lost><a-entity id=player position="-9 0 0" camera=userHeight:1.6 wasd-controls rotation="0 270 0" look-controls class=global><a-entity class=cursor cursor="fuse: true; fuseTimeout: 1000;" position="0 0 -3" geometry="primitive:circle; radius: 0.2;" material="color: cyan; shader: flat;" scale="0.2 0.2 0.2" raycaster="objects:.clickable; far:10"><a-animation begin=fusing end=mouseleave easing=ease-in attribute=scale from="1.0 1.0 1.0" to="0.2 0.2 0.2" fill=backwards duration=1000></a-animation></a-entity></a-entity></a-scene></body></html>